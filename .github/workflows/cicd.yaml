name: CI-CD-Scale-Tests

on:
  push:
    branches: ["main"]
  workflow_dispatch: {}

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt pytest httpx

      - name: Run tests
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: pytest -q

      - name: Build and Push Docker Image
        env:
          GHCR_USERNAME: ${{ secrets.GHCR_USERNAME }}
          GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
        run: |
          OWNER_LC="$(echo -n "$GHCR_USERNAME" | tr '[:upper:]' '[:lower:]')"
          echo "$GHCR_TOKEN" | docker login ghcr.io -u "$OWNER_LC" --password-stdin
          IMAGE="ghcr.io/$OWNER_LC/iris-api:${{ github.sha }}"
          echo "IMAGE=$IMAGE" >> $GITHUB_ENV
          echo "Using IMAGE=$IMAGE"
          docker build -t "$IMAGE" .
          docker push "$IMAGE"

      - name: Install gcloud and GKE auth plugin (Ubuntu 24.04)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y ca-certificates gnupg curl
          sudo mkdir -p /usr/share/keyrings /etc/apt/keyrings
          curl -fsSL https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo gpg --dearmor -o /usr/share/keyrings/cloud.google.gpg
          echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" | sudo tee /etc/apt/sources.list.d/google-cloud-sdk.list
          sudo apt-get update -y
          sudo apt-get install -y google-cloud-cli google-cloud-cli-gke-gcloud-auth-plugin
          echo "KUBECTL_USE_GKE_GCLOUD_AUTH_PLUGIN=True" >> $GITHUB_ENV

      - name: Authenticate to GCP (service account)
        env:
          GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
          GCP_PROJECT: ${{ secrets.GCP_PROJECT }}
        run: |
          echo "$GCP_SA_KEY" > $HOME/gcp-key.json
          gcloud auth activate-service-account --key-file="$HOME/gcp-key.json"
          gcloud config set project "$GCP_PROJECT"

      - name: Get GKE credentials (region or zone)
        env:
          GCP_PROJECT: ${{ secrets.GCP_PROJECT }}
          GCP_CLUSTER: ${{ secrets.GCP_CLUSTER }}
          GCP_LOCATION: ${{ secrets.GCP_LOCATION }}
        run: |
          gcloud container clusters get-credentials "$GCP_CLUSTER" --project "$GCP_PROJECT" --region "$GCP_LOCATION" ||           gcloud container clusters get-credentials "$GCP_CLUSTER" --project "$GCP_PROJECT" --zone "$GCP_LOCATION"

      - name: Patch manifest with new image
        run: |
          sed -i "s#ghcr.io/.*/iris-api:latest#${{ env.IMAGE }}#" k8s/deployment.yaml

      - name: Apply manifests
        run: |
          kubectl apply -f k8s/deployment.yaml -f k8s/service.yaml -f k8s/hpa.yaml

      - name: Wait for rollout
        run: kubectl rollout status deployment/iris-api --timeout=240s

      - name: Collect kubernetes diagnostics
        run: |
          mkdir -p artifacts
          kubectl get pods -o wide -l app=iris-api > artifacts/pods.txt
          kubectl describe deploy/iris-api > artifacts/deploy_describe.txt
          kubectl describe svc/iris-api > artifacts/svc_describe.txt
          kubectl get hpa iris-api -o yaml > artifacts/hpa.yaml || true
          kubectl get events --sort-by=.lastTimestamp | tail -n 200 > artifacts/events_tail.txt
      - name: Upload diagnostics
        uses: actions/upload-artifact@v4
        with:
          name: k8s-diagnostics
          path: artifacts/

      - name: Discover Service IP and smoke test
        id: smoke
        run: |
          SVC_IP="$(kubectl get svc iris-api -o jsonpath='{.status.loadBalancer.ingress[0].ip}')"
          echo "SVC_IP=$SVC_IP" >> $GITHUB_ENV
          echo "service_ip=$SVC_IP" >> $GITHUB_OUTPUT
          echo "Hitting http://$SVC_IP/healthz"
          curl -sf "http://$SVC_IP/healthz"
          echo
          echo "Posting to /predict"
          curl -sf -X POST "http://$SVC_IP/predict" -H 'Content-Type: application/json'             -d '{"X": [[5.1,3.5,1.4,0.2]]}'
          echo

      - name: Job Summary
        run: |
          {
            echo "## âœ… IRIS API deployed"
            echo ""
            echo "- **Image:** \`${{ env.IMAGE }}\`"
            echo "- **Service IP:** \`${{ steps.smoke.outputs.service_ip }}\`"
            echo ""
            echo "### Quick test"
            echo "\\`curl http://${{ steps.smoke.outputs.service_ip }}/healthz\\`"
            echo "\\`curl -X POST http://${{ steps.smoke.outputs.service_ip }}/predict -H 'Content-Type: application/json' -d '{"X": [[5.1,3.5,1.4,0.2]]}'\\`"
          } >> $GITHUB_STEP_SUMMARY

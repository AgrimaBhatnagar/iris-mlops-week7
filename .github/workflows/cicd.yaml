name: CI-CD-Scale-Tests

on:
  push:
    branches: ["main"]
  workflow_dispatch: {}

jobs:
  build-test-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt pytest httpx

      - name: Run tests
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: pytest -q

      # ---- GHCR login using PAT ----
      - name: Login to GHCR (PAT)
        env:
          GHCR_USERNAME: ${{ secrets.GHCR_USERNAME }}
          GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
        run: |
          echo "$GHCR_TOKEN" | docker login ghcr.io -u "$GHCR_USERNAME" --password-stdin

      - name: Build and push image
        env:
          GHCR_USERNAME: ${{ secrets.GHCR_USERNAME }}
        run: |
          OWNER_LC="$(echo -n "$GHCR_USERNAME" | tr '[:upper:]' '[:lower:]')"
          IMAGE="ghcr.io/${OWNER_LC}/iris-api:${{ github.sha }}"
          echo "IMAGE=$IMAGE" >> $GITHUB_ENV
          docker build -t "$IMAGE" .
          docker push "$IMAGE"

      # ---- Use official Google actions ----
      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          version: '>= 472.0.0'
          install_components: 'gke-gcloud-auth-plugin'

      - name: Auth to GCP (service account key)
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Get GKE credentials
        uses: google-github-actions/get-gke-credentials@v2
        with:
          project_id:   ${{ secrets.GCP_PROJECT }}
          cluster_name: ${{ secrets.GCP_CLUSTER }}
          location:     ${{ secrets.GCP_LOCATION }}

      # --- Create/refresh imagePullSecret for private GHCR (safe if package is public) ---
      - name: Ensure GHCR pull secret exists
        env:
          GHCR_USERNAME: ${{ secrets.GHCR_USERNAME }}
          GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
        run: |
          kubectl -n default delete secret ghcrcred --ignore-not-found
          kubectl -n default create secret docker-registry ghcrcred \
            --docker-server=ghcr.io \
            --docker-username="$GHCR_USERNAME" \
            --docker-password="$GHCR_TOKEN" \
            --docker-email="none@example.com"
          kubectl -n default patch deploy/iris-api --type='merge' -p '{
            "spec": { "template": { "spec": { "imagePullSecrets": [ { "name": "ghcrcred" } ] } } }
          }' || true

      # --- Deploy without sed; set image directly; robust rollout with diagnostics ---
      - name: Deploy (set image) + rollout with diagnostics
        run: |
          set -euo pipefail
          echo "Injecting image: ${IMAGE}"
          kubectl -n default set image deploy/iris-api iris-api="${IMAGE}"

          # Avoid single-replica deadlocks
          kubectl -n default patch deploy/iris-api --type='merge' -p '{
            "spec": { "strategy": { "type": "Recreate", "rollingUpdate": null },
                      "progressDeadlineSeconds": 300,
                      "template": { "spec": { "terminationGracePeriodSeconds": 10 } } }
          }' || true

          # Apply svc/HPA idempotently
          kubectl apply -f k8s/service.yaml -f k8s/hpa.yaml

          echo "Waiting for rollout..."
          set +e
          kubectl -n default rollout status deployment/iris-api --timeout=360s
          ROLL_RC=$?
          set -e
          if [ $ROLL_RC -ne 0 ]; then
            echo "Rollout timed out - dumping diagnostics"
            kubectl -n default get pods -l app=iris-api -o wide || true
            kubectl -n default get rs -l app=iris-api || true
            kubectl -n default get events --sort-by=.lastTimestamp | tail -n 80 || true
            kubectl -n default describe deploy/iris-api | sed -n '1,200p' || true
            for p in $(kubectl -n default get pods -l app=iris-api -o name); do
              echo "--- $p ---"; kubectl -n default logs "$p" --tail=200 || true
            done
            exit 1
          fi

      - name: Smoke test
        id: smoke
        run: |
          SVC_IP="$(kubectl get svc iris-api -o jsonpath='{.status.loadBalancer.ingress[0].ip}')"
          echo "service_ip=$SVC_IP" >> $GITHUB_OUTPUT
          curl -sf "http://$SVC_IP/healthz"
          curl -sf -X POST "http://$SVC_IP/predict" -H 'Content-Type: application/json' \
            -d '{"X":[[5.1,3.5,1.4,0.2]]}'

      - name: Summary
        run: |
          {
            echo "## âœ… IRIS API deployed"
            echo "- Image: ${IMAGE}"
            echo "- Service IP: ${{ steps.smoke.outputs.service_ip }}"
          } >> $GITHUB_STEP_SUMMARY

      - name: Load test with wrk (30s, 1000 conc)
        id: wrk
        run: |
          SVC_IP="$(kubectl get svc iris-api -o jsonpath='{.status.loadBalancer.ingress[0].ip}')"
          echo "SVC_IP=$SVC_IP"
          docker run --rm williamyeh/wrk \
            -t16 -c1000 -d30s \
            -s /usr/share/wrk/scripts/post.lua \
            http://$SVC_IP/predict \
            -- \
            '{"X":[[5.1,3.5,1.4,0.2]]}' 'Content-Type: application/json' | tee wrk.out
          RPS=$(grep -Eo 'Requests/sec:\s+[0-9.]+' wrk.out | awk '{print $2}')
          LAT=$(grep -A1 'Latency' wrk.out | tail -n1 | awk '{print $1$2}')
          echo "rps=$RPS" >> $GITHUB_OUTPUT
          echo "lat=$LAT" >> $GITHUB_OUTPUT

      - name: Snapshot HPA / Pods after load
        id: snap
        run: |
          echo '```' >> hpa.txt
          kubectl get hpa >> hpa.txt
          echo '' >> hpa.txt
          kubectl describe hpa iris-api | sed -n '1,120p' >> hpa.txt
          echo '' >> hpa.txt
          kubectl get pods -l app=iris-api -o wide >> hpa.txt
          echo '```' >> hpa.txt

      - name: Append results to Summary
        run: |
          {
            echo "## ðŸš€ Load Test Results"
            echo ""
            echo "- **Requests/sec:** \`${{ steps.wrk.outputs.rps }}\`"
            echo "- **Latency (summary):** \`${{ steps.wrk.outputs.lat }}\`"
            echo ""
            echo "### HPA / Pods after load"
            cat hpa.txt
          } >> $GITHUB_STEP_SUMMARY
